# 策划文档

此文档记录策划思路以及工作安排

## 2017-7-21-Friday

接下来需要完成的任务:

1. 优化编辑器,尤其是地图编辑器和怪物数值编辑器,以便后续能够方便设置数值
2. 优化事件结构，把部分数据挪到拥有事件的对象或者地图位置上
3. 继续完成事件,主要是地图传送事件、道具事件和选择事件，另外还要为一次性事件添加自移除机制
4. 优化已完成的事件，主要是对话事件和战斗事件的屏幕适配
5. 优化 JsonParser , 采用就地截取制,或者干脆把Json处理成 binary, 用 binary 读取,总之要提高配置读取速度
6. 优化UI资源，使其更美观
7. 为战斗添加跳数字标志和 Miss 标志，更正美术资源
8. 简略设置一批数值，然后集中 debug 已完成的功能
9. 整理代码格式和框架结构，添加必要的注释
10. 打出 android 包和 iOS 包，通过功能测试和适配测试
11. 添加几个大型动画资源，例如开场动画，VS boss 动画等

## 2017-8-23-Wednesday

+ 事件结构已优化, 基本通过测试
+ 地图编辑器的 bug 已修复, 现在可以正常编辑地图了
+ 获取基本资源型道具的事件已完成, 需要进一步测试（在2楼摆放更多物品进行测试）
+ 跨地图传送事件已通过测试，但是有一个 bug (见下)
+ 怪物数据编辑器需要进行便利性优化, 这是接下来要进行的工作
+ Bug: 重要级，跨地图第一次传送时，由于载入延迟，导致角色传送后多走了一步
+ Bug: 一般级，退出地图编辑器然后进入游戏时，报错，无法正常游戏
+ Bug: 轻微级，开门时，仍然可以继续触发开门事件（会继续扣钥匙并重复播放音效），应加入一个开门 loading 状态来解决此问题

## 2017-8-24-Thursday

1. 完成 loading 幕布的动画
2. 解决开门事件重复触发的 bug
3. **完成 choice 事件的功能**
4. 对对话框, 战斗框和选择框进行适配和UI优化, 添加跳数字和跳 Miss 的效果
5. 对前几层进行正式的内容规划设计, 并反复测试功能和体验
6. 优化数据读取(如[2017-7-21](#2017-7-21-Friday)中第5点所述)
7. 配置好 android 包, ios 包和 win-app-store 的包, 尝试打包
8. 整理代码结构, 添加必要注释

## 2017-9-14-Thursday

1. 对对话框, 战斗框和选择框进行适配和UI优化, 添加跳数字和跳 Miss 的效果
2. **完成choice事件的功能**
3. 对前几层进行正式的内容规划设计, 并反复测试功能和体验
4. 整理代码结构, 添加必要注释
5. 优化数据读取(如[2017-7-21](#2017-7-21-Friday)中第5点所述)
6. 配置好 android 包, ios 包和 win-app-store 的包, 尝试打包

## 2017-9-29-Friday

1. 完成 CallEventAt 事件和 CannotMove 事件
2. 完成部分道具的实际效果数值及首次 Tips 提示
3. 继续对对话框, 战斗框和选择框进行适配和UI优化, 添加跳数字和跳 Miss 的效果
4. **完成 choice 事件的功能**，完成商店功能
5. 继续设计前几层的内容，补充剧情，调整设计和数值, 并反复测试功能和体验
6. 整理代码结构, 添加必要注释
7. 优化数据读取(如[2017-7-21](#2017-7-21-Friday)中第5点所述)
8. 配置好 android 包, ios 包和 win-app-store 的包, 尝试打包

## 2018-3-16-Friday
1. 关于 choice 事件功能,有如下工作需要继续完成:
 + ~~按钮响应功能~~ ([2018.3.17](#2018-3-17-Saturday))
 + ~~选项间距适配~~ ([2018.4.19](#2018-4-19-Thursday))
 + 整个 choice 框的高度适配, 以及语言文本框部分的高度适配, 可能需要与字体大小适配一起进行
 + speaker 头像修正,及位置适配
 + 选项指示, 快捷键
 + 选项文本内容的数值 replace
 + 更丰富的选取和选择特效, 例如颜色变化, 音效等
 + 字体大小的适配, 框位置的适配
2. 关于战斗框, 有如下工作需要完成:
 + 字体大小适配, 框位置的适配
 + 战斗失败功能
 + 框大小的适配, 长宽比不要太大
 + 中途撤退功能, 暂停功能, 插入对话功能
 + 战斗胜利和战斗失败音效
 + 战斗结果提示修正
 + 资源替换
 + 跳数字, 跳 miss 的资源,音效及功能
3. 关于对话框和 tips 框, 有如下工作需要完成:
 + ~~字体大小适配, 框位置的适配~~ [(2018.4.25)(2018.6.13](#2018-4-24-Tuesday) 完成了框位置的随屏幕缩放适配)
4. 关于传送功能, 有如下工作需要完成:
 + curtain 内容添加(楼层, 传送时选择功能, 将来还会添加传送时缩略地图, 还有就是 Esc 主菜单提示)
 + curtain 淡入淡出功能
 + 传送音效, 同层传送角色淡入淡出功能
 + 测试传送阵跨地图传送功能
5. 完成部分道具的实际效果数值及首次Tips提示
6. 设计前11层的内容, 补充对话和商店功能, 测试体验
7. 配置好 android 包, ios 包和 win-app-store 的包, 尝试打包
8. 整理代码结构, 添加必要注释, 把 MainScene 里过于臃肿的功能代码尝试分离出来, 各种对话框可以尝试分离成 prefab
9. 添加几个大型动画资源，例如开场动画，VS boss 动画等

## 2018-3-17-Saturday
1. 修复了 choice 按钮响应的 bug, bug 产生原因是: 按钮被 curtain 挡住; 解决方法是: 让 curtain隐藏, 即 SetActive(false), 在需要显示时再出现
2. 下一项工作: 调整选项的位置和大小适配, 解决选项首次出现时, 选项个数不对的问题

## 2018-4-19-Thursday
1. 修正了 choice 按钮的选项列表适配和大小间距适配, 采用了 VerticalLayoutGroup 控件, 不再使用代码进行适配, 但框的高度仍然用代码适配, 目前在较小高度的屏幕上仍有问题, 需要稍后解决

## 2018-4-24-Tuesday
1. 已经重构了整个项目代码结构, 进行了更工整的分类, 并且将所有对话框从 MainScene 中分离了出来. 分离出来的对话框, 功能基本正常, ~~但是表现上仍有一些头像错误(应该是第一次写时生成头像的代码 copy 错误)的问题, 需要检查代码. 另外, 适配还没有优化~~(这些问题与[2018年12月](#2018-12-5-Wednesday)陆续全部解决)
2. 添加了对象池 ObjectPool. 现在, 所有的 Prefab, 都加入了对象池
3. 完成了对 Android 平台以及 WebGL 平台的打包测试, 可以正常运行. 但 WebGL 平台有无法显示中文的问题, 以及内存过大(与 json 读取方式过于低效有关)的问题, 512MB 内存仍不能满足, 必须要优化数据读取.
4. 已经优化了初始化方式. 现在, 每个 Scene 都可以独立初始化, 无需从 StartScene 进入

## 2018-6-29-Friday
1. 自动寻路已完成, 仍有如下问题:
 + ~~终点为不可过物品时仍然不能正常寻路(路径大于2长度)~~([2019年1月19日](#2019-1-19-Saturday)已解决)
 + 需要将可过门设为0优先级(完全可过)路径, 同时将带有传送事件的地方设置为9优先级(不可过)路径, 否则传送事件会使自动寻路出问题
 + ~~安卓手机上关于事件触发和 Touch 判定有着各种各样奇怪的 bug, 需要专门针对性调试, 找出问题原因, 不确定 iOS 上是否有此类问题~~([2018年7月3日](#2018-7-3-Tuesday))
 
## 2018-7-3-Tuesday
1. 安卓的大部分 bug 已修复:
 + 触摸事件同时也会触发 Mouse 左键事件, 因此在有触摸点的情况下对鼠标事件进行了屏蔽
 + 修复了一个无法触发对话后续事件的 bug (新写出的 bug)
2. 修复了对象池的 bug, 由于没有记录 id 导致存取时不一样, 对象池无法生效, 旧对象持续积累
3. 下一步继续修复 bug, 包括寻路仍然检测终点的 bug
4. ~~发现一个 bug: 寻路最优路径筛选有误, 没有选择绕路的高优先级路径~~([2019年1月19日](#2019-1-19-Saturday)已解决)
5. ~~发现一个 bug: 寻路结束后, 必须再点击一下才能(通过点击目的地)继续正常寻路~~([2019年1月19日](#2019-1-19-Saturday)已解决)
6. 出现过一个偶现 bug : 自动寻路开门时, 某种点击方法可使门无限循环播放开门 (难以复现)

## 2018-7-20-Friday
1. 完成了对国际化语言字符串的整理和调用, 现在继续整理和优化数据编辑器以便更好地设置数据

## 2018-12-5-Wednesday
1. 修复了一个 bug, 曾导致从 StartScene 进入 DataEditorScene 然后退回到 StartScene 之后, 此时若再进入到 MainScene 或 DataEditorScene , 将会崩溃. bug 原因是: 退出 Scene 时没有对 ObjectPool 进行清空

## 2018-12-6-Thursday
1. 修复了一个 bug, 曾导致 DataCenter 的数据被(DataEditorScene)改变之后, 没有同步到 MapManager, 也没有清空 MapManager, 致使改动无法实际生效 (仅仅是在编辑器选项栏中生效, 地图栏刷新以后也会复原)
2. 完成了对话/选择设计编辑器的UI摆放, 下一步完成功能, 同时优化编辑器其他部分
   
## 2018-12-7-Friday
1. 制作了一个简单的 ListView, 使用方式大致类似于 cocos2d 里的 ListView, 用于UI中的各种列表, 尚未测试, 添加到编辑器里进行测试

## 2018-12-10-Monday
1. 发现由于没有存档读取功能, 导致退出 MainScene 再重新进入时, 状态与退出前一样, 且在 DataEditorScene 修改楼层之后进入 MainScene 会有各种问题. 现在做了处理, 使得回到 StartScene 时重置地图数据, 但是人物数据还没有处理, 鉴于数据读取模块有可能重做, 先不处理
2. 完成了 ListView 的 debug 和应用
3. 为游戏中的 Sprite 建立了获取其 Image 的接口, 实际上直接通过 SpriteRenderer 获得 sprite 就行
4. 利用 ListView 完成了编辑器的 prefab 列表
5. 修复了编辑器 Modal 编辑的一个 bug, 这是由于 Id 比其 index 大1而之前未做处理(直接将 dropdown 获得的 index 当作id)
6. 接下来需要 ~~给编辑器中用到 prefab 或者 modal 的地方添加图片展示~~ (2018.12.11已完成) , ~~并修复下拉框不能自动滑动到所选项区域(导致每次都要滑很长)的问题~~ (2018.12.11决定无限期推迟, 因为稍微有点繁琐, 且并没有太大必要), 这些解决之后再去整理 DataEditorScene 的代码, 之后再去填充 String 类编辑器的功能

## 2018-12-12-Wednesday
1. 完成了字符串编辑功能
2. 整理了 DataEditorScene 的结构, 将多 Canvas 改成 Panel, 计划把 MainScene 也按此修改, 以后不再出现多个 Canvas 的情况
3. 为 TipBar 添加延时自移除功能

## 2018-12-18-Tuesday
1. 编辑器的 Chat/Choice 内容列表还未完成, 决定先把游戏内的功能解决一波
2. 尝试了一下将 DialogCanvas 合并进主 Canvas, 发现不太好使, 又还原了
   
## 2018-12-19-Wednesday
1. 使用 ContentSizeFitter 和 VerticalLayoutGroup 的结合, 彻底解决了 Choice 对话框的大小自动适配问题, 删掉了代码的原相关功能部分
2. 精调了所有5个对话框的适配问题, 现在总体上没问题了, 剩下如下bug:
 + ~~Choice 对话框人物头像位置仍有问题, 原因不明~~([2018年12月20日](#2018-12-20-Thursday)解决), 但另需要注意, Choice 对话框并没有在进入 Mainscene 时进行预加载
 + ~~Battle 对话框的文字位置仍需要调整~~([2018年12月21日](#2018-12-21-Friday)解决)
3. 给 ObjectPool 添加了设定 Sprite 的 SortingOrder 的功能, 以解决 Sprite 层级混乱的问题
4. 修复了一个 bug, 曾导致 Zzhit 被瞬间移除, 并因此导致攻击频率过高, 原因是加入 ObjectPool 后, Zzhit 在被 reuse 时没有重置计时器

## 2018-12-20-Thursday
1. 解决 Choice 对话框的所有适配 bug.
2. 解决 Choice 的一个 bug, 曾导致选完选项后, 后续键盘选择仍然会触发 Choice 的选项事件(点击后, 选项被按照 Checkbox 的形式已被锁定), 致使对话事件触发时, 游戏状态被还原至非对话状态, 从而造成对话 bug (理论上战斗等情况也会触发此bug)
3. 由于现在游戏标准分辨率被设定为1136*640, 因此, 所有UI图标按照这个分辨率进行了重设 (之前在此分辨率下显得扁一些)

## 2018-12-21-Friday
1. 整理了 Battle 对话框的位置及适配问题
2. 为主界面添加了叉和菜单按钮, 菜单栏先不必做
3. 仍有如下问题需要修复:
   + 寻路相关 bugs (见[2018年7月3日记录](#2018-7-3-Tuesday)及[2018年6月29日](#2018-6-29-Friday)记录)
   + 解决数据读取问题, 思考新的读取方案和编辑保存方案

## 2018-12-24-Monday
完成了幕布动画

## 2019-1-9-Wednesday
1. 修复了一个对象池的 bug, 曾导致不能正确播放所有攻击音效
2. 添加了文件操作及 HTTP 操作的类, 以备用
3. 添加了 ChoiceDlg 对鼠标移动操作的选择响应
4. 发现一个 bug: ChoiceDlg 中时, 点击任何非选项的地方会取消掉对任何选项的选择, 此时方向键将无法恢复选择项 (影响不大, 暂不处理)

## 2019-1-18-Friday
1. ~~处理寻路bug过程中造成了一个新的 bug, 导致在寻找直线上无法通过的目标点时, 程序陷入无限循环, bug 尚未弄清楚, 初步判定是更改寻路逻辑时, 造成了某些树的回路 (父节点形成了环). git尚未提交, 将在问题解决之后再提交. 将会给LinkedTree添加一个机制, 使得整个树中不能有重复引用的节点, 然后排查问题~~([2019年1月19日](#2019-1-19-Saturday)解决).

## 2019-1-19-Saturday
1. 采用 yield return 重构了 LinkedTree 的迭代器, 不再使用继承 IEnumerator 的派生类, 并以此大幅简化了迭代器代码, 同时修复了[2019年1月18日](#2019-1-18-Friday)所描述的问题, 问题原因是原 LinkedTree 中, 搜索父节点的最后一步如果失败(即整个迭代器到终点), 没有移除最后一个根节点 children 的迭代器, 导致最后一个节点被无限次重复迭代.
2. 按照昨天的计划, 修复了一部分寻路 bug:
   + 现在, 寻路终点为不可过物品时, 能够正常寻路至终点旁并触发可能存在的终点事件
   + 现在, 寻路已经可以正常筛选最优路径, 即先寻找空路, 没有的话寻找捡取宝物最少的路径, 仍没有则寻找怪物最少的路径, 只不过目前暂不能判断怪物强弱
   + 现在, 寻路到开门后不会再保持在AutoStepping状态以至于需要多点击一下才能继续寻路
   + 修复了寻路路径筛选逻辑, 尽可能比以前有更大概率选择较短路线. 但是由于算法缺陷, 目前的寻路算法无法保证最短路径, 如需修复, 需要重新设计算法, 目前暂时不做考虑
3. 仍然有一个偶现的寻路 bug, 详见[2018年7月3日](#2018-7-3-Tuesday)第6点, 由于无法复现且没有重要影响, 暂时不作处理
4. 去掉了 ArmyAntJson, 用 UnityEngine.JsonUtility 代替, 加快了加载速度, 但要注意是否有 bug, 因为 Unity 自带的这个 Json 解析器不是很好用, 容易出现很多 bug
5. 加入了 steamwork sdk, 以备用
6. 接下来给编辑器添加自动保存文件的功能, 把 Json 自动保存到 Unity 的缓存处, 不用再手动拷贝 Json 内容

## 2019-2-21-Thursday
1. 添加了对游戏手柄的支持, 但由于PC下Xbox, PC下PS4, Mac下PS4 三种手柄的键位映射皆不相同, 所以后续需要对手柄类型进行判断之后再做统一处理, 目前添加的初步支持Xbox
2. 上个月更新了Steam库的Unity属性, 区分平台, 手机平台暂不接入Steam

## 2019-2-27-Wednesday
1. 完成了编辑器将数据保存到文件的功能, 删除了原来的显示区域
2. 接下来的工作: 处理并测试通过关于 ChoiceDlg 的事件触发, 可以的话, 增加新的事件类型或是改进当前的事件结构
3. 接下来的工作: 修复 ChoiceDlg 的点击 bug, 详见[2019年1月9日](2019-1-9-Wednesday)第四点
4. 接下来的工作: 整理混乱的代码结构, 必要时重构
5. 接下来的工作: 整理混乱的适配情况

## 2019-3-16-Saturday
1. 大幅整理了代码, 重构进行到了一半, 修复了一个因重构暴露出来(以前不知道为什么不存在)的 bug: 幕布被 SetActive(false) 之后无法被激活
2. 新代码结构采用 MVP 模式, 但因历史原因, Presenter 仍被叫做 Controller, Model 仍被叫做 Data

## 2019-3-18-Monday
1. 代码重构基本完成, 比之前清晰了很多, 接下来可以重点调整事件结构了

## 2019-3-20-Wednesday
1. 对 EventData 结构进行了改造，改成了数组，目前正在对编辑器的EventData编辑部分进行改造，还有涉及 ListView 的诸多问题，改造完编辑器再对每一种具体事件类型进行修改

## 2019-3-21-Thursday
1. 编辑器的 EventData 编辑功能已全部可用, 代码也已拓展为其他地方可通用, 代码部分还剩下对其他地方(modal, chat, choice)的 EventData 设置的逻辑，界面上已加入到 chat 和 choice
2. ~~发现编辑器的保存功能出现报错~~, 已修复, 原因是父目录 MapData 未创建, 因此增加了创建目录的方法, 另外优化了几个方法的参数以减少字符串的拼接
3. EventData 结构改造已经完成, 接下来完善事件类型和具体实现, 然后就可以编辑数据了: 
    + 改造 GetBaseResourceItem 事件, 使之支持扣钱, 支持商店动态改价
    + ~~改造商店数据使之支持显示动态价格~~ 已实现显示, 只差事件支持

## 2019-3-22-Friday
1. GetBaseResourceItem 事件改造完成, 现在支持任何资源获取和购买, 支持购买成功事件和失败事件, 支持变价扣除, 但是暂不支持特殊物品获取, 需要在添加特殊物品系统时改进
2. 存读档逻辑功能已经完成, 尚未进行充分测试, 需要等存读档界面功能制作后进行充分测试, 目前, 开始新游戏是从读档逻辑走的
3. 动态价格支持已全面完成, 在 choice 中已经可以正常使用
4. 为 choice 的每个选项加了一个 close 字段, 用以决定点击后整个 choice 框是刷新还是关闭
5. 删除了一些无用的默认参数, 对所有 UI 上的文本进行了国际化字符串适配
6. 对常用的物件的名称进行了国际化字符串适配
7. 加入了国际化字符串的查重机制, 对重复的id或者key报warning
8. 适当调整了各个 UI 的字体和颜色, 在常用的几种屏幕比例上, 适配基本没什么问题了
9. 通过了mac上对 macOS, iOS 以及 Android 的打包
10. 现在可以对前10层的 Demo 进行数据设计了

## 2019-3-25-Monday
1. 完成了一部分打包问题的排查解决，为此修改（增加）了一些基本打包设置
2. 完成了开始界面的语言切换功能
3. 正在制作 Game Over 功能，缺少一个美术特效

## 2019-3-26-Tuesday
1. 丰富了 Curtain 的内容, 完成了 GameOver 效果
2. 重新导入了 Google Firebase SDK 和 Google MobAds SDK, 并尝试初始化和测试 MobAds
3. 修复了大多数动画的节奏不协调问题
4. 为所有代码添加了 namespace 并根据结构再次重新整理了代码文件目录和一些代码结构, 减小了代码耦合度
5. DataEditor 现在修改map会立即保存到内存, 删除了 Apply Map 按钮

## 2019-3-27-Wednesday
1. Google MobAds 通过了 Android 机器上的测试, 现在可以顺利调用 MobAds 了, 但是需要优化调用体验, 另需要测试 iOS 上的情况

## 2019-3-28-Thursday
1. Google MobAds 通过了 iPhone simulator 上的测试, 调用结构也得到了优化, ios模拟器上广告加载会产生一个奇怪的失败, 目前暂时无解决办法, 估计不影响正常使用. 除此以外, 现在可以完全正常调用广告模块
2. 修复了点按窗口关闭或编辑器停止按钮突然关闭游戏时, 资源卸载报错的问题, 问题原因是, 突然关闭时不会调用 Scene 的 OnDestroy, 导致没有调用 ClearMap 和 ObjectPool.ClearAll
3. 尝试添加了 Analytics 的代码, 同时调用 GoogleFirebaseAnalytics 和 UnityAnalytics, 需要后续完成
4. 在卡顿的 iOS 模拟器上发现了一个可疑 bug: 当画面因卡顿而丢帧时, player 的方向转换可能无法生效 (转向那一帧丢帧, 导致人物按照原方向的朝向进行走动, 多发生在自动寻路起步, 后续转向则正常)

